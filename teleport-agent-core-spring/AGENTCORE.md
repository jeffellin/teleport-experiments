# AgentCore Integration

This gateway routes requests to AWS Bedrock AgentCore with JWT token transformation.

## Supported Endpoints

### 1. `/ping` - Health Check
**Method:** `GET`
**Port:** 8080
**Purpose:** Verify that the AgentCore agent container is running and responsive

```bash
curl -H "Authorization: Bearer $TELEPORT_JWT" \
  http://localhost:8080/ping
```

### 2. `/invocations` - Agent Interactions
**Method:** `POST`
**Port:** 8080
**Purpose:** Main agent interactions and task execution

```bash
curl -X POST \
  -H "Authorization: Bearer $TELEPORT_JWT" \
  -H "Content-Type: application/json" \
  -d '{"action":"invoke","parameters":{...}}' \
  http://localhost:8080/invocations
```

### 3. `/ws` - WebSocket Endpoint
**Protocol:** WebSocket
**Port:** 8080
**Purpose:** Real-time bidirectional streaming

```bash
# Using wscat (npm install -g wscat)
wscat -c "ws://localhost:8080/ws" \
  -H "Authorization: Bearer $TELEPORT_JWT"

# Using websocat (https://github.com/vi/websocat)
websocat "ws://localhost:8080/ws" \
  --header "Authorization: Bearer $TELEPORT_JWT"
```

### 4. `/mcp/**` - Model Context Protocol
**Method:** Various
**Port:** 8000 (on AgentCore)
**Purpose:** Model Context Protocol server endpoints

```bash
curl -H "Authorization: Bearer $TELEPORT_JWT" \
  http://localhost:8080/mcp/endpoint
```

## Configuration

### Gateway Routes (application.yml:10-52)

The gateway is configured with specific routes for all AgentCore endpoints:

```yaml
spring:
  cloud:
    gateway:
      routes:
        # AgentCore ping endpoint (health check)
        - id: agentcore-ping
          uri: ${agentcore.endpoint}
          predicates:
            - Path=/ping
            - Method=GET

        # AgentCore invocations endpoint (main agent interactions)
        - id: agentcore-invocations
          uri: ${agentcore.endpoint}
          predicates:
            - Path=/invocations
            - Method=POST

        # AgentCore WebSocket endpoint (real-time streaming)
        - id: agentcore-websocket
          uri: ${agentcore.endpoint.ws}
          predicates:
            - Path=/ws/**

        # Model Context Protocol (MCP) endpoint
        - id: agentcore-mcp
          uri: ${agentcore.endpoint.mcp}
          predicates:
            - Path=/mcp/**
```

### AgentCore Configuration (application.yml:64-74)

```yaml
agentcore:
  # AgentCore HTTP endpoint URL (default port 8080)
  endpoint: https://gateway.bedrock-agentcore.us-east-1.amazonaws.com
  # AgentCore WebSocket endpoint URL (port 8080, path /ws)
  endpoint.ws: wss://gateway.bedrock-agentcore.us-east-1.amazonaws.com
  # AgentCore MCP endpoint URL (port 8000, mount path /mcp)
  endpoint.mcp: https://gateway.bedrock-agentcore.us-east-1.amazonaws.com:8000
  # Issuer for the minted JWT
  issuer: https://your-gateway.example.com
  # Audience for the minted JWT
  audience: agentcore-gateway
```

## How It Works

1. **Client** sends request with **Teleport JWT** to any AgentCore endpoint
2. **TeleportToAgentCoreTokenFilter** (TeleportToAgentCoreTokenFilter.java:71):
   - Extracts and validates Teleport JWT (if validation enabled)
   - Extracts `user_name` and `roles` claims
   - Mints new AgentCore JWT with these claims
3. **Gateway** routes to appropriate backend:
   - `/ping`, `/invocations` → Port 8080
   - `/ws/**` → Port 8080 via WebSocket (wss://)
   - `/mcp/**` → Port 8000
4. **AgentCore** processes request with proper authentication

## JWT Transformation

### Input (Teleport JWT)
```json
{
  "user_name": "alice@example.com",
  "roles": ["developer", "admin"],
  "sub": "alice@example.com",
  "iat": 1703784000,
  "exp": 1703787600
}
```

### Output (AgentCore JWT)
Generated by `AgentCoreTokenMinter` (service/AgentCoreTokenMinter.java:36):
```json
{
  "iss": "https://your-gateway.example.com",
  "sub": "alice@example.com",
  "aud": ["agentcore-gateway"],
  "username": "alice@example.com",
  "auth_source": "teleport",
  "teleport_roles": ["developer", "admin"],
  "scope": "mcp:invoke mcp:tools",
  "iat": 1703784000,
  "exp": 1703787600
}
```

## Testing

### HTTP Endpoints
```bash
export JWT="your-jwt-here"

# Test ping
curl -H "Authorization: Bearer $JWT" http://localhost:8080/ping

# Test invocations
curl -X POST -H "Authorization: Bearer $JWT" \
  -H "Content-Type: application/json" \
  -d '{"action":"test"}' \
  http://localhost:8080/invocations

# Test MCP endpoint
curl -H "Authorization: Bearer $JWT" http://localhost:8080/mcp/tools
```

### WebSocket Endpoint
```bash
# Install wscat: npm install -g wscat
wscat -c "ws://localhost:8080/ws" \
  -H "Authorization: Bearer $JWT"
```

### Test with httpbin (fallback route)
Any path not matching AgentCore routes falls through to httpbin:

```bash
curl -H "Authorization: Bearer $JWT" http://localhost:8080/get
```

### Run automated tests
```bash
./test-gateway.sh
```

## Route Priority

Routes are evaluated in order (first match wins):

1. `/ping` (GET) → AgentCore port 8080 (HTTP)
2. `/invocations` (POST) → AgentCore port 8080 (HTTP)
3. `/ws/**` → AgentCore port 8080 (WebSocket)
4. `/mcp/**` → AgentCore port 8000 (HTTP)
5. `/**` (catch-all) → httpbin.org (for testing only)

**Note:** To disable the httpbin fallback route in production, remove or comment it out from `application.yml`.